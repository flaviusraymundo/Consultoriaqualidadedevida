// src/components/WelcomeStep.tsx
import React, { useState, useEffect, FormEvent } from "react";
import { getBasePath } from "../utils/images";
import { useTranslation, Trans } from "react-i18next";
import { applyAuthTenant, getTenant, setTenantFromCode } from "../utils/tenant";
import { buildFunctionUrl } from "../utils/functions";
import { fetchAuthMe } from "../utils/auth";
import SiteFooter from "./SiteFooter";

type Props = {
  startProcess: () => void;
  isPro: boolean;
  onRequestRestore: (email: string) => Promise<void>;
  restoreLoading: boolean;
  restoreError: string | null;
  onRoleChange?: (role: "basic" | "pro") => void;
};

export default function WelcomeStep({
  startProcess,
  isPro,
  onRequestRestore,
  restoreLoading,
  restoreError,
  onRoleChange,
}: Props) {
  const logoUrl = `${getBasePath()}/images/logo.png`;
  const { t, i18n } = useTranslation();
  const [emailInput, setEmailInput] = useState("");
  const [refCode, setRefCode] = useState("");
  const [proPin, setProPin] = useState("");
  const [proMsg, setProMsg] = useState("");
  const [role, setRole] = useState<"basic" | "pro">(isPro ? "pro" : "basic");
  const isEN = i18n.language?.toLowerCase().startsWith("en");
  const effectivePro = role === "pro";

  useEffect(() => {
    try {
      const tenant = getTenant();
      setRefCode((tenant.code || "").trim());
    } catch {}
  }, []);

  useEffect(() => {
    let active = true;
    (async () => {
      const info = await fetchAuthMe();
      if (!active) return;
      const detected = info?.role === "pro" || isPro ? "pro" : "basic";
      setRole(detected);
      onRoleChange?.(detected);
    })();
    return () => {
      active = false;
    };
  }, [isPro, onRoleChange]);

  useEffect(() => {
    if (isPro && role !== "pro") {
      setRole("pro");
    }
  }, [isPro, role]);

  const applyRole = (nextRole: "basic" | "pro", message?: string) => {
    setRole(nextRole);
    onRoleChange?.(nextRole);
    if (typeof message === "string") setProMsg(message);
  };

  const handleRestore = async (e: FormEvent) => {
    e.preventDefault();
    if (!emailInput.trim() || restoreLoading) return;
    await onRequestRestore(emailInput.trim());
  };

  return (
    <div className="min-h-screen w-full flex flex-col">
      <div className="flex-1 w-full flex items-center justify-center px-4">
        <div className="text-center space-y-8 max-w-xl mx-auto w-full">
          <div className="flex justify-center mb-6">
            <img
              src={logoUrl}
              alt="Logo"
              className="h-72 w-auto md:h-[21rem] object-contain"
              draggable={false}
              loading="eager"
              fetchPriority="high"
              width={672}
              height={672}
            />
          </div>

          <div className="space-y-4">
            <h1 className="text-5xl font-bold text-gray-800 mb-2 whitespace-pre-line">
              {t("welcome.title")}
            </h1>
            <p className="text-xl text-gray-600 leading-relaxed">
              {effectivePro ? t("welcome.subtitlePro") : t("welcome.subtitleOnline")}
            </p>
          </div>

          {!effectivePro && (
            <p className="text-sm text-gray-500 max-w-xl mx-auto">
              {t("welcome.methodNote")}
            </p>
          )}

          {/* PRIMEIRO: Botão de iniciar */}
          <div className="space-y-4">
            <form
              onSubmit={async (e) => {
                e.preventDefault();
                const trimmed = refCode.trim();
                setRefCode(trimmed);
                if (trimmed) {
                  await setTenantFromCode(trimmed);
                } else {
                  await setTenantFromCode("");
                }
                startProcess();
              }}
              className="space-y-3"
            >
              <input
                id="ther-code"
                type="text"
                value={refCode}
                onChange={(e) => setRefCode(e.target.value)}
                placeholder={isEN ? "Therapist code (optional)" : "Código do terapeuta (opcional)"}
                className="w-56 sm:w-64 rounded-md border px-3 py-2 text-sm"
                autoCapitalize="off"
                autoCorrect="off"
                spellCheck={false}
              />
              <button
                type="submit"
                className="w-full px-12 py-4 bg-blue-600 text-white text-xl font-semibold rounded-xl hover:bg-blue-700 transform hover:scale-[1.015] transition-all duration-200 shadow-lg hover:shadow-xl"
              >
                {t("welcome.start", isEN ? "Start mapping" : "Iniciar Novo Mapeamento")}
              </button>
            </form>

            <p className="text-sm text-gray-500">
              <Trans
                i18nKey="welcome.pressEnterHint"
                components={[
                  <kbd
                    key="k"
                    className="px-2 py-1 bg-gray-200 rounded text-xs font-mono"
                  />,
                ]}
              />
            </p>
          </div>

          {/* DEPOIS: Recuperação por e-mail */}
          <form
            onSubmit={handleRestore}
            className="bg-white/70 backdrop-blur rounded-xl border border-gray-200 p-6 text-left shadow-sm space-y-4 mb-0"
          >
            <h3 className="text-lg font-semibold text-gray-800 flex items-center gap-2">
              {isEN ? "Recover Previous Mapping" : "Recuperar Mapeamento Anterior"}
            </h3>
            <p className="text-sm text-gray-600">
              {isEN
                ? "Enter your e-mail. If a record exists, we'll preload your last selection."
                : "Digite seu e-mail. Se houver registro, vamos recuperar sua última seleção."}
            </p>
            <div className="flex flex-col sm:flex-row gap-3">
              <input
                id="welcome-email"
                name="email"
                type="email"
                required
                autoComplete="email"
                inputMode="email"
                autoCapitalize="off"
                autoCorrect="off"
                spellCheck={false}
                placeholder={isEN ? "you@example.com" : "voce@exemplo.com"}
                className="flex-1 rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                value={emailInput}
                onChange={(e) => setEmailInput(e.target.value)}
                disabled={restoreLoading}
              />
              <button
                type="submit"
                disabled={restoreLoading || !emailInput.trim()}
                className="px-5 py-2.5 rounded-md bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-700 disabled:opacity-60 disabled:cursor-not-allowed transition-colors"
              >
                {restoreLoading
                  ? isEN
                    ? "Restoring..."
                    : "Restaurando..."
                  : isEN
                  ? "Recover"
                  : "Recuperar"}
              </button>
            </div>
            {restoreError && (
              <p className="text-xs text-red-600">{restoreError}</p>
            )}
            <p className="text-xs text-gray-500">
              {isEN
                ? "We do not store passwords; only last selection labels."
                : "Não armazenamos senha; apenas a última seleção rotulada."}
            </p>
            <p className="text-[11px] text-gray-400 -mt-3">
              {isEN
                ? "If no previous record exists for this email, just start a new mapping."
                : "Se não existir registro para esse e-mail, basta iniciar um novo mapeamento."}
            </p>
          </form>

          {/* BLOCO DO TERAPEUTA */}
          <div className="mt-6 mb-12 flex justify-end">
            <div className="space-y-3 border border-gray-300 rounded-lg p-6 text-center bg-gray-50/80 backdrop-blur max-w-sm w-full sm:w-auto">
              <h3 className="text-base font-semibold">
                {isEN ? "Therapist access" : "Acesso do terapeuta"}
              </h3>
              {effectivePro ? (
                <div className="flex flex-col sm:flex-row sm:items-center gap-2 text-sm text-gray-700">
                  <button
                    type="button"
                    onClick={async () => {
                      setProMsg(isEN ? "Ending session..." : "Encerrando sessão...");
                      try {
                        await fetch(buildFunctionUrl("/.netlify/functions/auth-logout"), {
                          method: "POST",
                          credentials: "include",
                        });
                      } catch {}
                      try { localStorage.setItem("mode", "online"); } catch {}
                      setProPin("");
                      applyAuthTenant({ therapist_id: null });
                      applyRole("basic", isEN ? "Session ended." : "Sessão encerrada.");
                    }}
                    className="w-64 py-2.5 rounded-md bg-gray-900 text-white text-sm font-medium hover:bg-gray-800 transition-colors"
                  >
                    {isEN ? "Exit Pro mode" : "Sair do modo Pro"}
                  </button>
                  {proMsg && <p className="text-xs text-gray-600">{proMsg}</p>}
                </div>
              ) : (
                <form
                  onSubmit={async (e) => {
                    e.preventDefault();
                    setProMsg(isEN ? "Checking PIN..." : "Validando PIN...");
                    try {
                      const response = await fetch(buildFunctionUrl("/.netlify/functions/auth-pin-login"), {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        credentials: "include",
                        body: JSON.stringify({ pin: proPin }),
                      });
                      if (!response.ok) throw new Error("invalid");
                      let payload: { tenant_id?: string; therapist_id?: string | null } | null = null;
                      try {
                        payload = await response.json();
                      } catch {
                        payload = null;
                      }
                      setProPin("");
                      try { localStorage.setItem("mode", "terapeuta"); } catch {}
                      if (payload?.tenant_id) {
                        applyAuthTenant({
                          tenant_id: payload.tenant_id,
                          therapist_id: payload.therapist_id ?? undefined,
                        });
                      }
                      applyRole("pro", isEN ? "Pro mode enabled." : "Modo Pro ativado.");
                    } catch {
                      setProMsg(isEN ? "Invalid PIN." : "PIN inválido.");
                    }
                  }}
                  className="space-y-3 flex flex-col items-center"
                >
                  <input
                    type="password"
                    required
                    value={proPin}
                    onChange={(e) => setProPin(e.target.value)}
                    placeholder={isEN ? "PIN" : "PIN"}
                    className="w-64 rounded-md border px-3 py-2 text-sm text-center"
                    autoComplete="one-time-code"
                    inputMode="numeric"
                  />
                  <div className="flex flex-col items-center gap-2">
                    <button
                      type="submit"
                      className="w-64 py-2.5 rounded-md bg-gray-900 text-white text-sm font-medium hover:bg-gray-800 transition-colors"
                    >
                      {isEN ? "Enter Pro mode" : "Entrar no modo Pro"}
                    </button>
                    {proMsg && <p className="text-xs text-gray-600">{proMsg}</p>}
                  </div>
                </form>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Espaço visual entre área e pre-footer */}
      <div className="pb-12"></div>

      {/* Footer fora do container interno */}
      <SiteFooter isEN={isEN} />
    </div>
  );
}
